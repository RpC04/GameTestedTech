name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main 

jobs:
  deploy:
    runs-on: ubuntu-latest 
    name: Deploy
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20' 

      - name: Install Dependencies
        run: npm install

      - name: Create .env file and Build App
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ vars.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_GA_MEASUREMENT_ID: ${{ vars.NEXT_PUBLIC_GA_MEASUREMENT_ID }}
        run: |
          echo "NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}" >> .env.production.local
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}" >> .env.production.local
          echo "NEXT_PUBLIC_GA_MEASUREMENT_ID=${NEXT_PUBLIC_GA_MEASUREMENT_ID}" >> .env.production.local
          npm run build

      - name: Deploy to Cloudflare
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          npx opennextjs-cloudflare build --skip-next-build
          npx esbuild .open-next/worker.js --bundle --outfile=.open-next/assets/_worker.js --format=esm --main-fields=module,main --external:cloudflare:workers --external:node:* --external:async_hooks --external:fs --external:path --external:url --external:buffer --external:crypto --external:stream --external:util --external:vm --external:http --external:https --external:zlib --external:string_decoder --external:events --external:os --external:tty --external:net --external:tls --external:assert --external:child_process --external:module --external:worker_threads
          npx wrangler pages deploy .open-next/assets --commit-dirty=true --project-name=gametestedtech